<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadet & Corporal Setup - Drosera</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* your existing styles... plus copy button style */
    body { margin:0; height:100vh; display:flex; align-items:center; justify-content:center; overflow:hidden; background:#0d0d0d; color:#fff; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; position:relative; }
    canvas { position:absolute; top:0; left:0; width:100%; height:100%; z-index:0; }
    .step-card { background: rgba(0,0,0,0.85); padding:30px; border-radius:20px; text-align:left; z-index:1; max-width:900px; width:95%; }
    pre { background:#0f0f0f; color:#ff8533; padding:15px; border-radius:10px; overflow-x:auto; white-space:pre-wrap; }
    .btn-next { background:#ff6600; color:#fff; font-weight:bold; border:none; padding:12px 30px; border-radius:30px; margin-top:12px; }
    .copy-btn { position:absolute; top:12px; right:12px; background:#444; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .ai-response { background:#0b0b0b; color:#e6eef8; padding:12px; border-radius:8px; margin-top:12px; white-space:pre-wrap; }
    .small-muted { color:#bbb; font-size:0.9rem; }
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>

  <div class="step-card">
    <div class="d-flex justify-content-between align-items-start">
      <h3 id="stepTitle">Loadingâ€¦</h3>
      <div class="small-muted" id="stepCounter"></div>
    </div>

    <p id="stepDesc" class="small-muted"></p>

    <div id="commandsArea"></div>

    <p class="mt-2">Have you completed this step?</p>
    <button id="btnProceed" class="btn-next">âœ… Yes, Proceed</button>

    <p class="mt-3">Or paste any error you got:</p>
    <textarea id="errorBox" placeholder="Paste terminal error output here..." rows="5" style="width:100%; padding:10px; border-radius:8px;"></textarea>
    <button id="btnSubmitError" class="btn-next">âš¡ Submit Error</button>

    <div id="aiAnswer" class="ai-response" style="display:none;"></div>
  </div>

  <script>
    // background particle animation (same as homepage)
    const canvas = document.getElementById('bgCanvas'), ctx = canvas.getContext('2d');
    function resetCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight; }
    window.addEventListener('resize', ()=>{ resetCanvas(); initParticles(); });
    resetCanvas();

    let particles=[];
    class Particle { constructor(x,y,s,sx,sy){Object.assign(this,{x,y,size:s,sx,sy});}
      update(){ this.x += this.sx; this.y += this.sy; if(this.x<0||this.x>canvas.width)this.sx*=-1; if(this.y<0||this.y>canvas.height)this.sy*=-1;}
      draw(){ ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fillStyle='rgba(255,102,0,0.7)'; ctx.fill(); }
    }
    function initParticles(){ particles=[]; for(let i=0;i<50;i++){ particles.push(new Particle(Math.random()*canvas.width, Math.random()*canvas.height, Math.random()*3+2, (Math.random()-0.5)*2, (Math.random()-0.5)*2)); } }
    function animate(){ ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach(p=>{p.update(); p.draw();}); for(let a=0;a<particles.length;a++){for(let b=a;b<particles.length;b++){const dx=particles[a].x-particles[b].x, dy=particles[a].y-particles[b].y, d=Math.sqrt(dx*dx+dy*dy); if(d<120){ ctx.beginPath(); ctx.strokeStyle='rgba(255,102,0,0.12)'; ctx.moveTo(particles[a].x,particles[a].y); ctx.lineTo(particles[b].x,particles[b].y); ctx.stroke(); }}} requestAnimationFrame(animate); }
    initParticles(); animate();

    // UI + logic
    let guide = null;
    let stepIdx = parseInt(localStorage.getItem('drosera_step') || '0', 10);

    async function loadGuide(){
      try {
        guide = await fetch('/data/drosera_guide.json').then(r=>r.json());
        renderStep(stepIdx);
      } catch (err) {
        console.error(err);
        document.getElementById('stepTitle').innerText = 'Failed to load guide';
        document.getElementById('stepDesc').innerText = 'Make sure /public/data/drosera_guide.json is present.';
      }
    }

    function renderStep(i){
      const s = guide.steps[i];
      if(!s){
        document.getElementById('stepTitle').innerText = 'All done';
        document.getElementById('commandsArea').innerHTML = '<p>Completed all steps.</p>';
        document.getElementById('stepCounter').innerText = '';
        return;
      }
      document.getElementById('stepTitle').innerText = `Step ${i+1}: ${s.title}`;
      document.getElementById('stepDesc').innerText = (s.notes||[]).join(' â€¢ ') || '';
      document.getElementById('stepCounter').innerText = `${i+1}/${guide.steps.length}`;

      // build commands area (commands array or substeps)
      const area = document.getElementById('commandsArea'); area.innerHTML='';
      const commands = s.commands || (s.substeps ? s.substeps.flatMap(ss => ss.commands || []) : []);
      if(commands.length){
        // assemble a single code block
        const codeId = 'codeBlock';
        const wrapper = document.createElement('div');
        wrapper.style.position='relative';
        wrapper.innerHTML = `<pre id="${codeId}">${commands.join('\n')}</pre>`;
        const btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'ðŸ“‹ Copy';
        btn.onclick = ()=> copyCode(codeId);
        wrapper.appendChild(btn);
        area.appendChild(wrapper);
      } else if(s.substeps && s.substeps.length){
        s.substeps.forEach((ss, idx)=>{
          const sub = document.createElement('div');
          sub.innerHTML = `<strong>${ss.title}</strong><pre id="code_${idx}">${(ss.commands||[]).join('\n')}</pre>`;
          const btn = document.createElement('button');
          btn.className='copy-btn'; btn.textContent='ðŸ“‹ Copy';
          btn.onclick = ()=> copyCode(`code_${idx}`);
          sub.style.position='relative';
          sub.appendChild(btn);
          area.appendChild(sub);
        });
      } else {
        area.innerHTML = '<p class="small-muted">No commands in this step.</p>';
      }
    }

    // copy helper
    async function copyCode(id){
      const text = document.getElementById(id).innerText;
      try{ await navigator.clipboard.writeText(text); flashTemporary('Copied to clipboard'); } catch(e){ alert('Copy failed'); }
    }
    function flashTemporary(msg){
      const el = document.createElement('div');
      el.style.position='fixed'; el.style.right='20px'; el.style.top='20px'; el.style.background='#222'; el.style.color='#fff'; el.style.padding='8px 12px'; el.style.borderRadius='8px'; el.style.zIndex=9999;
      el.innerText=msg; document.body.appendChild(el);
      setTimeout(()=>el.remove(),1500);
    }

    // call API for either "proceed" (no error) or "submit error"
    async function askAI({ step, username, error }) {
      // Show loading
      const aiEl = document.getElementById('aiAnswer');
      aiEl.style.display='block'; aiEl.innerText = 'AI is thinkingâ€¦';
      try {
        const r = await fetch('/api/ask', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ username, step, error })
        });
        const j = await r.json();
        if (j.error) aiEl.innerText = 'Error: ' + (j.error || JSON.stringify(j));
        else aiEl.innerText = j.answer || 'No answer';
      } catch (e) {
        aiEl.innerText = 'Request failed: ' + e.message;
      }
    }

    // proceed button: ask AI to display the step content (strictly based on JSON)
    document.getElementById('btnProceed').addEventListener('click', async ()=>{
      const username = localStorage.getItem('discordUsername') || 'anonymous';
      const step = guide.steps[stepIdx];
      // Ask AI to show exact commands/notes for this step (AI will only echo step info; mainly useful for formatting or additional brief checks)
      await askAI({ step, username, error: null });
      // mark step completed locally and advance
      stepIdx = Math.min(stepIdx + 1, guide.steps.length);
      localStorage.setItem('drosera_step', String(stepIdx));
      setTimeout(()=>renderStep(stepIdx), 700); // allow user to read AI answer first
    });

    // submit error: send error text + step to AI to troubleshoot
    document.getElementById('btnSubmitError').addEventListener('click', async ()=>{
      const err = document.getElementById('errorBox').value.trim();
      if(!err) return alert('Please paste the error output first.');
      const username = localStorage.getItem('discordUsername') || 'anonymous';
      const step = guide.steps[stepIdx];
      await askAI({ step, username, error: err });
    });

    // quick username check: if missing, prompt using browser prompt (or use the earlier selection page)
    if(!localStorage.getItem('discordUsername')){
      const u = prompt('Enter your Discord username (used for progress):');
      if(u) localStorage.setItem('discordUsername', u);
      else localStorage.setItem('discordUsername','anonymous');
    }

    // initial load
    loadGuide();
  </script>
</body>
</html>
