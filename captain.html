<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drosera PoC Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #0d0d0d;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #bgCanvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 0;
        }

        .step-card {
            z-index: 1;
            background: rgba(24, 24, 24, 0.85);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            position: relative;
            max-width: 600px;
            width: 95%;
            margin: auto;
        }

        .btn-true {
            background: #ff6600;
            color: #fff;
            font-weight: bold;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            transition: all 0.3s ease-in-out;
            white-space: pre-wrap;
        }

        .btn-false {
            background: #8e44ad;
            color: #fff;
            font-weight: bold;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            transition: all 0.3s ease-in-out;
        }

        /* NEW STYLE for the Bypass Button */
        .btn-bypass {
            background: #27ae60;
            /* A clear, distinct color */
            color: #fff;
            font-weight: bold;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            transition: all 0.3s ease-in-out;
            margin-top: 15px;
            width: 100%;
        }

        pre {
            text-align: left;
        }

        @media (max-width: 768px) {
            .d-flex {
                flex-direction: column !important;
            }
        }
    </style>
</head>

<body>
    <canvas id="bgCanvas"></canvas>

    <div class="d-flex align-items-center justify-content-center vh-100">
        <div class="step-card">

            <div id="step-start" class="text-center">
                <h2 class="mb-3">Drosera PoC Generator</h2>
                <p class="text-light">Do you already have a PoC idea, or would you like AI to suggest one?</p>
                <div class="d-flex justify-content-center gap-3">
                    <button class="btn-false" onclick="showStep('idea')">I have an idea</button>
                    <button class="btn-true" onclick="showStep('generate')">Suggest Ideas</button>
                </div>
            </div>

            <div id="step-idea" class="d-none">
                <h4 class="mb-3">Enter your PoC Idea</h4>
                <textarea id="userIdea" class="form-control mb-3" rows="4"
                    placeholder="Describe your PoC idea"></textarea>
                <button class="btn btn-warning w-100" onclick="generateRepo()">Generate Repo</button>
            </div>

            <div id="step-generate" class="d-none">
                <h4 class="mb-3">AI-Generated Ideas</h4>
                <div id="idea-options" class="d-flex flex-column mb-3 text-light"></div>
            </div>

        </div>
    </div>

    <script>
        // Background Canvas Animation (Same as before)
        const canvas = document.getElementById('bgCanvas'),
            ctx = canvas.getContext('2d');

        function resetCanvas() {
            canvas.width = innerWidth;
            canvas.height = innerHeight;
        }
        window.addEventListener('resize', () => {
            resetCanvas();
            initParticles();
        });
        resetCanvas();

        let particles = [];
        class Particle {
            constructor(x, y, s, sx, sy) {
                Object.assign(this, {
                    x,
                    y,
                    size: s,
                    sx,
                    sy
                });
            }
            update() {
                this.x += this.sx;
                this.y += this.sy;
                if (this.x < 0 || this.x > canvas.width) this.sx *= -1;
                if (this.y < 0 || this.y > canvas.height) this.sy *= -1;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255,102,0,0.7)';
                ctx.fill();
            }
        }

        function initParticles() {
            particles = [];
            for (let i = 0; i < 50; i++) {
                particles.push(new Particle(
                    Math.random() * canvas.width,
                    Math.random() * canvas.height,
                    Math.random() * 3 + 2,
                    (Math.random() - 0.5) * 2,
                    (Math.random() - 0.5) * 2
                ));
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.update();
                p.draw();
            });
            for (let a = 0; a < particles.length; a++) {
                for (let b = a; b < particles.length; b++) {
                    const dx = particles[a].x - particles[b].x,
                        dy = particles[a].y - particles[b].y,
                        d = Math.sqrt(dx * dx + dy * dy);
                    if (d < 120) {
                        ctx.beginPath();
                        ctx.strokeStyle = 'rgba(255,102,0,0.12)';
                        ctx.moveTo(particles[a].x, particles[a].y);
                        ctx.lineTo(particles[b].x, particles[b].y);
                        ctx.stroke();
                    }
                }
            }
            requestAnimationFrame(animate);
        }
        initParticles();
        animate();

        // -----------------------------------------------------------
        // --- USER ACCESS AND COOLDOWN LOGIC ---
        // -----------------------------------------------------------
        const COOLDOWN_MS = 432000000; // 5 days in milliseconds

        /**
         * Checks if the user is eligible (client-side soft check only).
         */
        function isUserEligible(username) {
            // Remove the old bypass button every time eligibility is checked
            document.getElementById('correction-bypass-btn')?.remove();

            const lastSubmissionTime = localStorage.getItem(`pocSubmissionHistory_${username}`);

            if (!lastSubmissionTime) return true;

            const currentTime = new Date().getTime();
            const timeSinceLastSubmit = currentTime - parseInt(lastSubmissionTime, 10);

            if (timeSinceLastSubmit >= COOLDOWN_MS) return true;

            const remainingTimeMs = COOLDOWN_MS - timeSinceLastSubmit;
            const remainingDays = (remainingTimeMs / (1000 * 60 * 60 * 24)).toFixed(1);

            alert(`ðŸš« Cooldown Active: You must wait ${remainingDays} days before submitting a NEW PoC idea.`);
            return false;
        }

        /**
         * Records a new PoC submission time (Client-side record).
         */
        function recordSubmission(username) {
            localStorage.setItem(`pocSubmissionHistory_${username}`, new Date().getTime().toString());
        }

        /**
         * Dynamically adds a button to bypass cooldown for correction on the last idea.
         */
        function addBypassButton(username) {
            // CRITICAL FIX: Determine the correct visible container to append the button to.
            const container = document.getElementById('step-idea').classList.contains('d-none') ?
                document.getElementById('step-generate') :
                document.getElementById('step-idea');

            // Ensure the button is not duplicated
            if (document.getElementById('correction-bypass-btn')) return;

            const btn = document.createElement("button");
            btn.id = 'correction-bypass-btn';
            btn.className = "btn-bypass mt-3";
            btn.innerHTML = "ðŸ“ **Correction Mode:** Continue to Guide (Bypasses Cooldown)";

            btn.onclick = () => {
                // This bypasses the API call and redirects directly to the guide page.
                const lastIdea = localStorage.getItem("selectedIdea");

                if (!lastIdea) {
                    alert("No previous idea found to correct. Please submit a new one after cooldown.");
                    return;
                }

                // Redirect, sending the user and indicating a correction flow
                // The `correction=true` flag tells setup.html to skip generating a new guide.
                window.location.href = `setup.html?correction=true&user=${username}`;
            };

            // Append to the Idea or Generate step container
            container.appendChild(btn);
        }

        // SIMULATED LOGIN: Ensure a user is defined (replace with actual login flow)
        if (!localStorage.getItem('currentUser')) {
            let user = prompt("Please enter your username to proceed:");
            if (!user || user.trim() === "") user = 'guest_user';
            localStorage.setItem('currentUser', user.trim());
        }

        async function showStep(step) {
            document.querySelectorAll('.step-card > div').forEach(el => el.classList.add('d-none'));
            document.getElementById('step-' + step).classList.remove('d-none');
            // Remove bypass button when changing steps
            document.getElementById('correction-bypass-btn')?.remove();
            if (step === 'generate') {
                await fetchIdeas();
            }
        }

        async function fetchIdeas() {
            const container = document.getElementById('idea-options');
            container.innerHTML = "<p class='text-info'>âš¡ Bjorn consulting Jake for ideas... âš¡</p>";

            const username = localStorage.getItem('currentUser');

            if (!username || username === 'guest_user') {
                container.innerHTML = "<p class='text-danger'>Authentication failed. Please reload and enter a username.</p>";
                return;
            }

            try {
                // CRITICAL FIX: Ensure userIdea is retrieved from the input field when generating ideas
                // This input field is usually visible when the user clicks 'I have an idea' first,
                // but we check it here for context if they clicked 'Suggest Ideas' second.
                const userIdea = document.getElementById("userIdea")?.value.trim() || "General trap idea";

                const res = await fetch('/api/generateIdeas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userIdea, username })
                });

                if (res.status === 403) {
                    const errData = await res.json();
                    container.innerHTML = `<p class='text-danger'>${errData.error}</p>`;
                    // Cooldown active on the server, prompt for correction bypass
                    addBypassButton(username);
                    return;
                }

                const data = await res.json();

                if (data.error) {
                    container.innerHTML = `<p class='text-danger'>${data.error}</p>`;
                    console.error("Backend error:", data.raw || data.error);
                    return;
                }

                if (!data.ideas || !Array.isArray(data.ideas) || data.ideas.length === 0) {
                    container.innerHTML = "<p class='text-warning'>No ideas returned. Try again.</p>";
                    return;
                }

                container.innerHTML = "";
                data.ideas.forEach((idea) => {
                    const btn = document.createElement("button");
                    btn.className = "btn-true mb-2 text-start";
                    btn.innerHTML = `<strong>${idea.title}</strong> <span class="text-muted">[${idea.category}]</span>\n${idea.summary}`;
                    btn.onclick = () => {
                        // This click is starting a NEW PoC process, so enforce the cooldown
                        if (!isUserEligible(username)) {
                            // If cooldown is active, the bypass button is added by isUserEligible's internal call to addBypassButton
                            return;
                        }
                        // Save the selected idea context before proceeding
                        localStorage.setItem("selectedIdea", JSON.stringify(idea));
                        generateRepo(idea);
                    };
                    container.appendChild(btn);
                });
            } catch (err) {
                container.innerHTML = "<p class='text-danger'>Error fetching ideas.</p>";
                console.error(err);
            }
        }

        function generateRepo(idea) {
            const username = localStorage.getItem('currentUser');

            if (!username || username === 'guest_user') {
                alert("Please ensure you are logged in with a unique username.");
                return;
            }

            // --- 1. Perform Cooldown Check ---
            if (!isUserEligible(username)) {
                // If cooldown is active, show the bypass button and stop the process
                addBypassButton(username);
                return;
            }

            // --- 2. If Check Passes: Proceed with Generation ---

            if (!idea) {
                // Manual Idea Submission
                const userIdea = document.getElementById('userIdea').value.trim();
                if (!userIdea) {
                    alert("Please enter an idea first!");
                    return;
                }

                // Set the current idea in Local Storage to allow for correction later
                localStorage.setItem("selectedIdea", JSON.stringify({ userIdea: userIdea, title: "Manual Idea" }));

                // Redirect: The API call happens on setup.html when the user asks for the guide
                window.location.href = `setup.html?idea=${encodeURIComponent(userIdea)}&user=${username}`;

            } else {
                // AI Idea Submission (already selected)
                // Idea data is already in localStorage.selectedIdea from fetchIdeas click handler
                window.location.href = `setup.html?user=${username}`;
            }
        }
    </script>
</body>

</html>